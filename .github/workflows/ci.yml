name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Explicitly declare minimal permissions for security
permissions:
  contents: read

jobs:
  build:
    name: Build & Lint
    runs-on: macos-14
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          validate-wrappers: true

      - name: Check formatting
        run: ./gradlew spotlessCheck

      - name: Run Detekt
        run: ./gradlew detekt

      - name: Build Android Debug
        run: ./gradlew :androidApp:assembleDebug

      - name: Build iOS Framework
        run: ./gradlew :shared:linkDebugFrameworkIosSimulatorArm64

      - name: Run Tests
        run: ./gradlew :shared:allTests

  template-test:
    name: Template Generation
    runs-on: macos-14
    timeout-minutes: 20
    env:
      TEST_PROJECT: MyApp
      TEST_PACKAGE: com.example.myapp
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run setup.sh
        run: |
          printf '%s\n%s\n\ny\n' "$TEST_PROJECT" "$TEST_PACKAGE" | ./setup.sh

      - name: Verify no template references
        run: |
          FOUND=$(grep -rI -E "com[./]template[./]|com[./]template[^a-z0-9]|TemplateApp" . \
            --include="*.kt" --include="*.kts" --include="*.xml" \
            --include="*.swift" --include="*.plist" --include="*.pro" \
            --include="*.pbxproj" --include="*.xcscheme" \
            --exclude-dir=.git --exclude-dir=build --exclude-dir=.gradle \
            2>/dev/null | wc -l | tr -d ' ')
          if [ "$FOUND" -gt 0 ]; then
            echo "ERROR: Found template references in generated project:"
            grep -rI -E "com[./]template[./]|com[./]template[^a-z0-9]|TemplateApp" . \
              --include="*.kt" --include="*.kts" --include="*.xml" \
              --include="*.swift" --include="*.plist" --include="*.pro" \
              --include="*.pbxproj" --include="*.xcscheme" \
              --exclude-dir=.git --exclude-dir=build --exclude-dir=.gradle
            exit 1
          fi
          echo "No template references found"

      - name: Verify template artifacts removed
        run: |
          ERRORS=0
          for f in setup.sh CHANGELOG.md CONTRIBUTING.md SECURITY.md CODE_OF_CONDUCT.md docs/TEMPLATE_DEVELOPMENT.md docs/CONFIGURATION.md; do
            if [ -f "$f" ]; then
              echo "ERROR: Template file not removed: $f"
              ERRORS=$((ERRORS + 1))
            fi
          done
          if [ -d ".github" ]; then
            echo "ERROR: .github directory not removed"
            ERRORS=$((ERRORS + 1))
          fi
          if [ "$ERRORS" -gt 0 ]; then
            echo "Found $ERRORS template artifacts that should have been removed"
            exit 1
          fi
          echo "All template artifacts properly removed"

      - name: Run tests on generated project
        run: ./gradlew :shared:allTests

      - name: Build generated Android project
        run: ./gradlew :androidApp:assembleDebug

      - name: Build generated iOS framework
        run: ./gradlew :shared:linkDebugFrameworkIosSimulatorArm64
