name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Explicitly declare minimal permissions for security
permissions:
  contents: read

jobs:
  build:
    name: Build & Lint
    runs-on: macos-14
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v3

      - name: Check formatting
        run: ./gradlew spotlessCheck

      - name: Run Detekt
        run: ./gradlew detekt

      - name: Build Android Debug
        run: ./gradlew :androidApp:assembleDebug

      - name: Build iOS Framework
        run: ./gradlew :shared:linkDebugFrameworkIosSimulatorArm64

      - name: Run Tests
        run: ./gradlew testDebugUnitTest

  template-test:
    name: Template Generation - ${{ matrix.name }}
    runs-on: macos-14
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: standard
            package: com.example.myapp
            project: MyApp
          - name: deep
            package: io.company.product.mobile.app
            project: DeepApp
          - name: minimal
            package: app.mini
            project: MiniApp
    env:
      # Use env vars for matrix values to avoid injection risks
      TEST_PROJECT: ${{ matrix.project }}
      TEST_PACKAGE: ${{ matrix.package }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run setup.sh
        run: |
          printf '%s\n%s\n\ny\n' "$TEST_PROJECT" "$TEST_PACKAGE" | ./setup.sh

      - name: Verify no template references
        run: |
          FOUND=$(grep -r "com\.template" . --include="*.kt" --include="*.kts" --include="*.xml" --exclude-dir=.git 2>/dev/null | wc -l | tr -d ' ')
          if [ "$FOUND" -gt 0 ]; then
            echo "ERROR: Found $FOUND files with template references:"
            grep -r "com\.template" . --include="*.kt" --include="*.kts" --include="*.xml" --exclude-dir=.git -l
            exit 1
          fi
          echo "No template references found"

      - name: Build generated Android project
        run: ./gradlew :androidApp:assembleDebug

      - name: Build generated iOS framework
        run: ./gradlew :shared:linkDebugFrameworkIosSimulatorArm64
